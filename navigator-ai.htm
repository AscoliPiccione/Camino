<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navigatore Camino del Norte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Palette: Brilliant Blues & Pilgrim Greens */
        :root {
            --color-dark-blue: #004AAD;
            --color-medium-blue: #0094D1;
            --color-light-blue: #9BD3DD;
            --color-pilgrim-green: #2E7D32;
            --color-text: #333333;
            --color-background: #F7F7F7;
            --color-card-background: #FFFFFF;
            --color-ai-accent: #FFC107; /* Amber for AI features */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
        }
        .header-bg {
            background-color: var(--color-dark-blue);
        }
        .text-primary {
            color: var(--color-dark-blue);
        }
        .text-secondary {
            color: var(--color-pilgrim-green);
        }
        .btn-primary {
            background-color: var(--color-pilgrim-green);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #256528;
        }
        .btn-ai {
            background-color: var(--color-ai-accent);
            color: #333;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: background-color 0.2s;
            border: 2px solid transparent;
        }
        .btn-ai:hover {
            background-color: #ffca2c;
            border-color: #333;
        }
        .card {
            background-color: var(--color-card-background);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--color-medium-blue);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .albergue-item {
            border-left: 4px solid var(--color-light-blue);
            padding-left: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        .albergue-item:last-child {
            border-bottom: none;
        }
        .albergue-item.cheapest {
            border-left-color: var(--color-pilgrim-green);
        }
        .albergue-item.donativo {
            border-left-color: var(--color-dark-blue);
        }
        .ai-output {
            background-color: #FFFBEB; /* Light yellow background for AI responses */
            border-left: 4px solid var(--color-ai-accent);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            white-space: pre-wrap; /* Preserve formatting */
        }
        #townSelector {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="antialiased">
    <header class="header-bg shadow-md">
        <div class="container mx-auto px-4 py-6 text-center">
            <h1 class="text-4xl font-black text-white">Navigatore Camino del Norte</h1>
            <p class="text-xl mt-2 text-white">La tua guida potenziata dall'AI</p>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <!-- Sezione per la selezione della città -->
        <section id="location-section" class="card text-center">
            <h2 class="text-2xl font-bold mb-4 text-primary">Seleziona la tua Tappa</h2>
            <p class="mb-4 text-gray-700">Scegli una località dal menu per visualizzare tutte le informazioni utili.</p>
            <div class="flex flex-col md:flex-row items-center justify-center gap-4">
                <select id="townSelector" class="w-full md:w-1/2 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg">
                    <!-- Le opzioni verranno popolate da JavaScript -->
                </select>
                <button id="searchBtn" class="btn-primary">Cerca</button>
            </div>
            <div id="errorOutput" class="mt-4 text-red-600 font-semibold"></div>
        </section>

        <!-- Contenitore per i risultati dinamici -->
        <div id="results-container" class="hidden">
            <!-- Sezione Assistente AI -->
            <section id="ai-assistant-section" class="card">
                <h2 class="text-2xl font-bold mb-4 text-primary">Assistente Pellegrino ✨</h2>
                <div class="flex flex-col md:flex-row gap-4">
                    <button id="getTownInfoBtn" class="btn-ai flex-1">Cosa vedere qui? ✨</button>
                    <button id="planStageBtn" class="btn-ai flex-1">Pianifica la prossima tappa ✨</button>
                </div>
                <div id="aiLoading" class="loading-spinner mt-6 hidden"></div>
                <div id="aiOutput" class="ai-output hidden"></div>
                <div id="aiError" class="mt-4 text-red-600 font-semibold"></div>
            </section>

            <section id="albergues-section" class="card">
                <h2 class="text-2xl font-bold mb-4 text-primary">Albergue in Zona</h2>
                <div id="alberguesOutput" class="text-gray-700"></div>
            </section>
            
            <section id="amenities-section" class="card">
                <h2 class="text-2xl font-bold mb-4 text-primary">Servizi Utili</h2>
                <div id="amenitiesOutput" class="text-gray-700"></div>
            </section>

            <section id="advice-section" class="card">
                <h2 class="text-2xl font-bold mb-4 text-primary">Prossime Tappe</h2>
                <div id="adviceOutput" class="text-gray-700"></div>
            </section>
        </div>
    </main>

    <footer class="bg-white mt-12 py-6">
        <div class="container mx-auto px-4 text-center text-gray-600">
            <p>¡Buen Camino!</p>
            <p class="text-sm mt-2">Dati aggiornati e integrati da alberguescaminosantiago.com. Verifica sempre le informazioni sul posto.</p>
        </div>
    </footer>

    <script>
        // --- DATABASE DEL CAMINO DEL NORTE (AMPLIATO) ---
        const caminoData = [
            { 
                name: "Irun", 
                albergues: [{ name: "Albergue de Peregrinos Jakobi", type: "Pubblico", price: 10, address: "Calle Lesaka 1", beds: 56, notes: "Aperto da Marzo a Ottobre. Cucina disponibile." }], 
                amenities: { 
                    supermarkets: [{ name: "Mercadona", address: "Calle Anaka 11" }, { name: "Carrefour", address: "Paseo Colón 10" }],
                    pharmacies: [{ name: "Farmacia Lda. Ana M. Benito", address: "Paseo Colón 27" }],
                    bakeries: [{ name: "Ogi Berri", address: "Paseo Colón 25" }],
                    trekking_stores: [{ name: "Decathlon Irún", address: "Parque Comercial Txingudi" }]
                }, 
                nextTowns: [{ name: "Pasajes de San Juan", distance: 6 }, { name: "San Sebastián", distance: 25 }] 
            },
            { 
                name: "Pasajes de San Juan", 
                albergues: [{ name: "Albergue de Peregrinos Santa Ana", type: "Municipale", price: 12, address: "Plaza de Santiago", beds: 24, notes: "Aperto da Giugno a Settembre. No cucina." }], 
                amenities: { 
                    supermarkets: [],
                    pharmacies: [{ name: "Farmacia Lda. M. A. Pildain", address: "Donibane Kalea 65" }],
                    bakeries: [{ name: "Panadería Olibet", address: "Donibane Kalea 73" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "San Sebastián", distance: 6 }] 
            },
            { 
                name: "San Sebastián", 
                albergues: [{ name: "Albergue de Peregrinos La Sirena", type: "Pubblico", price: 18, address: "Paseo de Igeldo 25", beds: 102, notes: "Prenotazione obbligatoria. Cucina disponibile." }, { name: "Albergue Juvenil Ulía", type: "Pubblico", price: 15, address: "Paseo de Ulía 297", beds: 62, notes: "Leggermente fuori dal centro." }], 
                amenities: { 
                    supermarkets: [{ name: "Super Amara", address: "Calle de Urbieta 9" }, { name: "Mercadona", address: "Calle de San Martín 53" }],
                    pharmacies: [{ name: "Farmacia Echániz", address: "Avenida de la Libertad 23" }],
                    bakeries: [{ name: "Pastelería Oiartzun", address: "Calle Mayor 2" }],
                    trekking_stores: [{ name: "Ternua", address: "Calle de Elkano 7" }, { name: "Forum Sport", address: "Centro Comercial Garbera" }]
                }, 
                nextTowns: [{ name: "Orio", distance: 15 }, { name: "Zarautz", distance: 22 }] 
            },
            { 
                name: "Orio", 
                albergues: [{ name: "Albergue de Peregrinos San Martín", type: "Privato", price: 15, address: "Ermita de San Martín de Tours", beds: 20, notes: "Posizione panoramica con cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Eroski", address: "Aritzaga Kalea 20" }],
                    pharmacies: [{ name: "Farmacia Lda. M. J. Amas", address: "Aritzaga Kalea 1" }],
                    bakeries: [{ name: "Pastelería Sayalero", address: "Aritzaga Kalea 14" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Zarautz", distance: 5 }] 
            },
            { 
                name: "Zarautz", 
                albergues: [{ name: "Albergue de Peregrinos de Zarautz", type: "Municipale", price: 10, address: "Polideportivo Aritzbatalde, Calle Zumalakarregi 16", beds: 40, notes: "Aperto solo Luglio e Agosto. No cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Mercadona", address: "Nafarroa Kalea 10" }, { name: "Eroski", address: "Lapurdi Kalea 15" }],
                    pharmacies: [{ name: "Farmacia Lda. I. Eizaguirre", address: "Kale Nagusia 26" }],
                    bakeries: [{ name: "Pastelería Egaña", address: "Zigordia Kalea 41" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Getaria", distance: 5 }, { name: "Zumaia", distance: 10 }] 
            },
            { 
                name: "Getaria", 
                albergues: [], 
                amenities: { 
                    supermarkets: [{ name: "Coviran", address: "Krixketan-Bidea Kalea, 1" }],
                    pharmacies: [{ name: "Farmacia Olaizola", address: "Kale Nagusia 25" }],
                    bakeries: [{ name: "Gure Ogia", address: "Kale Nagusia 29" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Zumaia", distance: 5 }] 
            },
            { 
                name: "Zumaia", 
                albergues: [{ name: "Albergue de Peregrinos Convento de San José", type: "Parrocchiale", price: 10, address: "Calle San Jose 11", beds: 22, notes: "Aperto da Giugno a Settembre. No cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Eroski", address: "Eusebio Gurrutxaga Plaza" }],
                    pharmacies: [{ name: "Farmacia Ortopedia Sarasketa", address: "Erribera Kalea 20" }],
                    bakeries: [{ name: "Ogi Berri", address: "Aita Mari Kalea 1" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Deba", distance: 13 }] 
            },
            { 
                name: "Deba", 
                albergues: [{ name: "Albergue de Peregrinos Geltoki", type: "Municipale", price: 10, address: "Plaza de la Estación (Geltoki Plaza)", beds: 56, notes: "Aperto tutto l'anno. Cucina disponibile." }], 
                amenities: { 
                    supermarkets: [{ name: "Eroski", address: "Ifar Kalea 2" }],
                    pharmacies: [{ name: "Farmacia Lda. A. Azpiazu", address: "Ifar Kalea 10" }],
                    bakeries: [{ name: "Pastelería Egaña", address: "Hondartza Kalea 1" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Markina-Xemein", distance: 24 }] 
            },
            { 
                name: "Markina-Xemein", 
                albergues: [{ name: "Albergue de Peregrinos Convento del Carmen", type: "Parrocchiale", price: 15, address: "Plaza del Carmen 5", beds: 36, notes: "Ospitato in un convento. Cucina disponibile." }], 
                amenities: { 
                    supermarkets: [{ name: "Eroski", address: "Erdikokalea Kalea 12" }],
                    pharmacies: [{ name: "Farmacia Barinagarrementeria", address: "Guén Kalea 10" }],
                    bakeries: [{ name: "Ogi-Bake", address: "Zeharkalea 12" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Zenarruza", distance: 6 }, { name: "Gernika-Lumo", distance: 25 }] 
            },
            { 
                name: "Zenarruza", 
                albergues: [{ name: "Albergue del Monasterio de Zenarruza", type: "Monastico", price: 12, address: "Monasterio de Zenarruza", beds: 20, notes: "Esperienza unica in un monastero. No cucina." }], 
                amenities: { supermarkets: [], pharmacies: [], bakeries: [], trekking_stores: [] }, 
                nextTowns: [{ name: "Gernika-Lumo", distance: 19 }] 
            },
            { 
                name: "Gernika-Lumo", 
                albergues: [{ name: "Albergue Juvenil y de Peregrinos", type: "Pubblico", price: 15, address: "Calle Kortezubi 9", beds: 48, notes: "Struttura moderna con cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Mercadona", address: "Iparragirre Kalea 25" }, { name: "Eroski", address: "Juan Calzada Kalea 10" }],
                    pharmacies: [{ name: "Farmacia Adelaida Zarragoikoetxea", address: "Don Tello Kalea 1" }],
                    bakeries: [{ name: "Goizalde", address: "Barrenkalea 16" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Lezama", distance: 21 }] 
            },
            { 
                name: "Lezama", 
                albergues: [{ name: "Albergue de Peregrinos de Lezama", type: "Municipale", price: 5, address: "Barrio Garaioltza 133", beds: 20, notes: "Uno degli albergue più economici. Cucina disponibile." }], 
                amenities: { 
                    supermarkets: [{ name: "Supermercado Lezama", address: "Aretxalde Auzoa 50" }],
                    pharmacies: [{ name: "Farmacia Lezama", address: "Garaioltza Auzoa 87" }],
                    bakeries: [{ name: "Lezamako Okindegia", address: "Garaioltza Auzoa 85" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Bilbao", distance: 11 }] 
            },
            { 
                name: "Bilbao", 
                albergues: [{ name: "Albergue de Peregrinos Santa Cruz de Begoña", type: "Parrocchiale", price: 10, address: "Calle Padre Remigio Vilariño 1", beds: 22, notes: "Contributo suggerito. No cucina." }, { name: "Bilbao Akelarre Hostel", type: "Privato", price: 20, address: "Calle Morgan 4", beds: 60, notes: "Centrale e popolare. Cucina disponibile." }], 
                amenities: { 
                    supermarkets: [{ name: "Mercadona", address: "Plaza del Sagrado Corazón 5" }, { name: "Eroski", address: "Calle Buenos Aires 13" }],
                    pharmacies: [{ name: "Farmacia Indautxu", address: "Urkixo Zumarkalea 60" }],
                    bakeries: [{ name: "Pastelería Arrese", address: "Gran Vía 24" }],
                    trekking_stores: [{ name: "Decathlon City", address: "Gran Vía 20" }, { name: "The North Face Store", address: "Calle Ercilla 25" }]
                }, 
                nextTowns: [{ name: "Portugalete", distance: 19 }] 
            },
            { 
                name: "Portugalete", 
                albergues: [{ name: "Albergue de Peregrinos de Portugalete", type: "Municipale", price: 6, address: "Polideportivo Zubi Alde", beds: 30, notes: "Ottimo rapporto qualità-prezzo. Cucina disponibile." }], 
                amenities: { 
                    supermarkets: [{ name: "Eroski", address: "Carlos VII Hiribidea 15" }],
                    pharmacies: [{ name: "Farmacia Ortopedia J.L. Aperribay", address: "General Castaños Kalea 30" }],
                    bakeries: [{ name: "Pastelería Oiartzun", address: "General Castaños Kalea 15" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Pobeña", distance: 10 }, { name: "Castro-Urdiales", distance: 24 }] 
            },
            { 
                name: "Pobeña", 
                albergues: [{ name: "Albergue de Peregrinos de Pobeña", type: "Municipale", price: 10, address: "Barrio Pobeña", beds: 24, notes: "Aperto solo in estate (Giugno-Settembre). No cucina." }], 
                amenities: { supermarkets: [], pharmacies: [], bakeries: [], trekking_stores: [] }, 
                nextTowns: [{ name: "Castro-Urdiales", distance: 14 }] 
            },
            { 
                name: "Castro-Urdiales", 
                albergues: [{ name: "Albergue de Peregrinos de Castro Urdiales", type: "Municipale", price: 6, address: "Calle de la Rúa 19", beds: 16, notes: "Posti limitati, arrivare presto. Cucina disponibile." }, { name: "Albergue-Camping de Castro", type: "Privato", price: 15, address: "Barrio Campijo 65", beds: 44, notes: "Buona opzione con piscina e bar." }], 
                amenities: { 
                    supermarkets: [{ name: "Lupa", address: "Calle Leonardo Rucabado 25" }, { name: "Mercadona", address: "Avenida de la Constitución 1" }],
                    pharmacies: [{ name: "Farmacia Sámano", address: "Barrio Montealegre 23" }],
                    bakeries: [{ name: "Pastelería Vistalegre", address: "Calle la Rúa 21" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Islares", distance: 7 }, { name: "Laredo", distance: 20 }] 
            },
            { 
                name: "Islares", 
                albergues: [{ name: "Albergue de Peregrinos de Islares", type: "Municipale", price: 5, address: "Antiguo consultorio, Calle Escuela", beds: 18, notes: "Essenziale e molto economico. No cucina." }], 
                amenities: { supermarkets: [], pharmacies: [], bakeries: [], trekking_stores: [] }, 
                nextTowns: [{ name: "Liendo", distance: 8 }] 
            },
            { 
                name: "Liendo", 
                albergues: [{ name: "Albergue de Peregrinos Saturnino Candina", type: "Municipale", price: 10, address: "Barrio Hazas", beds: 30, notes: "Struttura accogliente con cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Supermercado Coviran", address: "Barrio la Portilla 20" }],
                    pharmacies: [{ name: "Farmacia de Liendo", address: "Barrio Hazas 24" }],
                    bakeries: [],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Laredo", distance: 5 }] 
            },
            { 
                name: "Laredo", 
                albergues: [{ name: "Albergue-Residencia Casa de la Trinidad", type: "Parrocchiale", price: 10, address: "Calle San Francisco 22", beds: 42, notes: "Atmosfera comunitaria, include cena e colazione." }, { name: "Albergue El Buen Pastor", type: "Privato", price: 15, address: "Calle Menéndez Pelayo 10", beds: 20, notes: "Alternativa privata con cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Lupa", address: "Avenida de Cantabria 1" }, { name: "Mercadona", address: "Calle Emperador 1" }],
                    pharmacies: [{ name: "Farmacia Central", address: "Calle Menéndez Pelayo 1" }],
                    bakeries: [{ name: "Confitería Santos", address: "Calle de San Francisco" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Güemes", distance: 29 }] 
            },
            { 
                name: "Güemes", 
                albergues: [{ name: "Albergue La Cabaña del Abuelo Peuto", type: "Donativo", price: 5, address: "Barrio de Gargollo", beds: 90, notes: "Un'istituzione del Camino, esperienza indimenticabile. Include cena e colazione." }], 
                amenities: { supermarkets: [], pharmacies: [], bakeries: [], trekking_stores: [] }, 
                nextTowns: [{ name: "Somo", distance: 8 }, { name: "Santander", distance: 12 }] 
            },
            { 
                name: "Somo", 
                albergues: [], 
                amenities: { 
                    supermarkets: [{ name: "Lupa", address: "Calle las Quebrantas" }],
                    pharmacies: [{ name: "Farmacia de Somo", address: "Calle la Fuente" }],
                    bakeries: [{ name: "Panadería Somo", address: "Calle las Dunas" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Santander", distance: 4 }] 
            },
            { 
                name: "Santander", 
                albergues: [{ name: "Albergue de Peregrinos Santos Mártires", type: "Municipale", price: 15, address: "Calle Ruamayor 7", beds: 40, notes: "Posizione centrale con cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Mercadona", address: "Calle de Castilla 71" }, { name: "Carrefour", address: "Calle Joaquín Costa 45" }],
                    pharmacies: [{ name: "Farmacia Amós de Escalante", address: "Calle de Burgos 5" }],
                    bakeries: [{ name: "Gallofa & Co", address: "Calle de Isabel II 23" }],
                    trekking_stores: [{ name: "Decathlon City", address: "Calle San Fernando 14" }, { name: "Deportes K2", address: "Calle de Lealtad 13" }]
                }, 
                nextTowns: [{ name: "Boo de Piélagos", distance: 15 }, { name: "Santillana del Mar", distance: 37 }] 
            },
            { 
                name: "Boo de Piélagos", 
                albergues: [{ name: "Albergue Piedad", type: "Privato", price: 15, address: "Barrio San Juan 144", beds: 24, notes: "Accogliente, con cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Supermercado Coviran", address: "Barrio la Piélagos 10" }],
                    pharmacies: [{ name: "Farmacia de Boo de Piélagos", address: "Avenida de Luis de la Concha 1" }],
                    bakeries: [],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Santillana del Mar", distance: 22 }] 
            },
            { 
                name: "Santillana del Mar", 
                albergues: [{ name: "Albergue de Peregrinos de Santillana del Mar", type: "Municipale", price: 10, address: "Plaza Abad Francisco Navarro", beds: 16, notes: "Posti limitati, nel cuore del borgo medievale." }, { name: "Albergue El Convento", type: "Privato", price: 15, address: "Calle Antonio Niceas 2", beds: 55, notes: "Grande e accogliente, con cena comunitaria." }], 
                amenities: { 
                    supermarkets: [{ name: "Supermercado Lupa", address: "Avenida de Le Dorat 1" }],
                    pharmacies: [{ name: "Farmacia de Santillana", address: "Plaza Mayor 10" }],
                    bakeries: [{ name: "Casa Quevedo", address: "Calle de Juan Infante 36" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Cóbreces", distance: 10 }, { name: "Comillas", distance: 17 }] 
            },
            { 
                name: "Cóbreces", 
                albergues: [{ name: "Albergue de la Abadía de Santa María de Viaceli", type: "Monastico", price: 10, address: "Monasterio Cisterciense", beds: 20, notes: "Ospitato in un'abbazia trappista. Cucina disponibile." }], 
                amenities: { 
                    supermarkets: [],
                    pharmacies: [{ name: "Farmacia de Cóbreces", address: "Barrio San Roque" }],
                    bakeries: [],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Comillas", distance: 7 }] 
            },
            { 
                name: "Comillas", 
                albergues: [{ name: "Albergue de Peregrinos de Comillas", type: "Municipale", price: 10, address: "Calle Antonio López 1", beds: 22, notes: "Aperto da Aprile a Ottobre. Cucina disponibile." }], 
                amenities: { 
                    supermarkets: [{ name: "Lupa", address: "Paseo de Solatorre" }],
                    pharmacies: [{ name: "Farmacia de Comillas", address: "Calle de los Vientos 5" }],
                    bakeries: [{ name: "Pastelería Teresas", address: "Plaza de la Constitución" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "San Vicente de la Barquera", distance: 12 }] 
            },
            { 
                name: "San Vicente de la Barquera", 
                albergues: [{ name: "Albergue de Peregrinos de San Vicente", type: "Municipale", price: 10, address: "Convento de San Luis, Calle Alta 10", beds: 30, notes: "Posizione storica con cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Lupa", address: "Avenida de los Soportales" }],
                    pharmacies: [{ name: "Farmacia del Dr. González", address: "Calle del Mercado 3" }],
                    bakeries: [{ name: "Panadería La Gloria", address: "Plaza Mayor del Fuero" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Colombres", distance: 11 }, { name: "Llanes", distance: 31 }] 
            },
            { 
                name: "Colombres", 
                albergues: [{ name: "Albergue El Cantu", type: "Pubblico", price: 15, address: "Calle Lamadrid", beds: 130, notes: "Grande struttura, no cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Supermercado Alimerka", address: "Plaza Manuel Ibáñez" }],
                    pharmacies: [{ name: "Farmacia de Colombres", address: "Calle de Francisco de la Borbolla" }],
                    bakeries: [],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Llanes", distance: 20 }] 
            },
            { 
                name: "Llanes", 
                albergues: [{ name: "Albergue de Peregrinos de Llanes", type: "Municipale", price: 10, address: "Calle Posada Herrera 5", beds: 38, notes: "Aperto da Pasqua a Ottobre. Cucina disponibile." }], 
                amenities: { 
                    supermarkets: [{ name: "Mercadona", address: "Calle de la Concepcion" }, { name: "Alimerka", address: "Calle de Celso Amieva" }],
                    pharmacies: [{ name: "Farmacia de Llanes", address: "Calle Mayor 1" }],
                    bakeries: [{ name: "Pastelería-Bombonería Vega", address: "Calle Pidal 1" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Ribadesella", distance: 30 }] 
            },
            { 
                name: "Ribadesella", 
                albergues: [{ name: "Albergue de Peregrinos de San Esteban de Leces", type: "Municipale", price: 10, address: "San Esteban de Leces (a 2km)", beds: 24, notes: "Posizione tranquilla fuori città, con cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Alimerka", address: "Calle del Comercio" }],
                    pharmacies: [{ name: "Farmacia de Ribadesella", address: "Gran Vía de Agustín Argüelles" }],
                    bakeries: [{ name: "Panadería-Confitería La Veguina", address: "Calle Manuel Caso de la Villa" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Colunga", distance: 17 }, { name: "Villaviciosa", distance: 29 }] 
            },
            { 
                name: "Colunga", 
                albergues: [], 
                amenities: { 
                    supermarkets: [{ name: "Alimerka", address: "Calle Grande Covián" }],
                    pharmacies: [{ name: "Farmacia de Colunga", address: "Calle Grande Covián" }],
                    bakeries: [],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Villaviciosa", distance: 12 }] 
            },
            { 
                name: "Villaviciosa", 
                albergues: [{ name: "Albergue de Peregrinos de Villaviciosa", type: "Municipale", price: 10, address: "Calle El Ancho 2", beds: 24, notes: "Aperto da Aprile a Ottobre. Cucina." }, { name: "Albergue El Congreso", type: "Privato", price: 14, address: "Plaza del Ayuntamiento 25", beds: 30, notes: "Centrale e conveniente." }], 
                amenities: { 
                    supermarkets: [{ name: "Mercadona", address: "Calle del Agua" }],
                    pharmacies: [{ name: "Farmacia de Villaviciosa", address: "Plaza del Ayuntamiento" }],
                    bakeries: [{ name: "Confitería Viena", address: "Calle del Sol" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Gijón (Costa)", distance: 29 }, { name: "Pola de Siero (Primitivo)", distance: 22 }] 
            },
            { 
                name: "Gijón (Costa)", 
                albergues: [{ name: "Albergue de Peregrinos de Gijón", type: "Municipale", price: 10, address: "Camping Deva, Camín de la Pasadiella 85", beds: 36, notes: "Situato nel camping, un po' fuori dal centro." }], 
                amenities: { 
                    supermarkets: [{ name: "Mercadona", address: "Avenida de la Costa 86" }, { name: "Alimerka", address: "Calle Corrida 20" }],
                    pharmacies: [{ name: "Farmacia Lda. Isabel de la Fuente", address: "Calle Corrida 3" }],
                    bakeries: [{ name: "La Casa del Chocolate", address: "Calle San Bernardo 20" }],
                    trekking_stores: [{ name: "Decathlon Gijón", address: "Parque Comercial Roces" }]
                }, 
                nextTowns: [{ name: "Avilés", distance: 25 }] 
            },
            { 
                name: "Pola de Siero (Primitivo)", 
                albergues: [{ name: "Albergue de Peregrinos de Pola de Siero", type: "Municipale", price: 8, address: "Calle Celleruelo 57", beds: 30, notes: "Per chi devia verso il Cammino Primitivo." }], 
                amenities: { 
                    supermarkets: [{ name: "Mercadona", address: "Calle Alcalde Parrondo" }],
                    pharmacies: [{ name: "Farmacia Central", address: "Calle Marquesa de Canillejas" }],
                    bakeries: [],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Oviedo", distance: 18 }] 
            },
            { 
                name: "Oviedo (Primitivo)", 
                albergues: [{ name: "Albergue de Peregrinos El Salvador", type: "Municipale", price: 8, address: "Calle Leopoldo Alas 20", beds: 51, notes: "Capitale del Cammino Primitivo." }], 
                amenities: { 
                    supermarkets: [{ name: "Mercadona", address: "Calle de Uría" }],
                    pharmacies: [{ name: "Farmacia Campoamor", address: "Calle Campoamor" }],
                    bakeries: [{ name: "Rialto", address: "Calle San Francisco" }],
                    trekking_stores: [{ name: "Decathlon Oviedo", address: "Centro Comercial Los Prados" }]
                }, 
                nextTowns: [] 
            },
            { 
                name: "Avilés", 
                albergues: [{ name: "Albergue de Peregrinos Pedro Solís", type: "Municipale", price: 10, address: "Calle de la Magdalena 1", beds: 44, notes: "Nel centro storico, con cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Mercadona", address: "Calle de la Cámara 41" }],
                    pharmacies: [{ name: "Farmacia Lda. Covadonga Nodal", address: "Calle la Fruta 12" }],
                    bakeries: [{ name: "Confitería la Duquesita", address: "Calle de la Fruta 1" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Soto de Luiña", distance: 39 }] 
            },
            { 
                name: "Soto de Luiña", 
                albergues: [{ name: "Albergue de Peregrinos de Soto de Luiña", type: "Parrocchiale", price: 10, address: "Plaza de la Iglesia", beds: 22, notes: "Accogliente e con cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Pequeño supermercado local", address: "Carretera General" }],
                    pharmacies: [{ name: "Farmacia de Soto de Luiña", address: "Carretera General" }],
                    bakeries: [],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Cadavedo", distance: 24 }] 
            },
            { 
                name: "Cadavedo", 
                albergues: [{ name: "Albergue de Peregrinos de Cadavedo", type: "Municipale", price: 8, address: "Antiche scuole", beds: 22, notes: "Struttura semplice con cucina." }], 
                amenities: { 
                    supermarkets: [],
                    pharmacies: [],
                    bakeries: [],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Luarca", distance: 16 }] 
            },
            { 
                name: "Luarca", 
                albergues: [{ name: "Albergue de Peregrinos de Luarca", type: "Municipale", price: 10, address: "Polígono La Capitana", beds: 28, notes: "Moderno, un po' fuori dal centro. Cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Alimerka", address: "Avenida de Galicia" }],
                    pharmacies: [{ name: "Farmacia de Luarca", address: "Calle Párroco Camino" }],
                    bakeries: [{ name: "Confitería Ancomar", address: "Paseo del Muelle" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "La Caridad", distance: 28 }] 
            },
            { 
                name: "La Caridad", 
                albergues: [{ name: "Albergue de Peregrinos de La Caridad", type: "Municipale", price: 10, address: "Avenida de Asturias", beds: 30, notes: "Buona sosta prima della Galizia. Cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Supermercado Claudio", address: "Avenida de Asturias" }],
                    pharmacies: [{ name: "Farmacia de La Caridad", address: "Avenida de Asturias" }],
                    bakeries: [],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Ribadeo", distance: 22 }] 
            },
            { 
                name: "Ribadeo", 
                albergues: [{ name: "Albergue de Peregrinos de Ribadeo", type: "Xunta", price: 10, address: "Carretera del Faro", beds: 24, notes: "Primo albergue pubblico in Galizia. Cucina." }, { name: "Albergue Viruxe", type: "Privato", price: 12, address: "Camiño Veiga da Aira 4", beds: 20, notes: "Opzione economica e accogliente." }], 
                amenities: { 
                    supermarkets: [{ name: "Gadis", address: "Avenida de Galicia" }, { name: "Eroski", address: "Calle San Roque" }],
                    pharmacies: [{ name: "Farmacia Álvarez", address: "Calle Rodríguez Murias" }],
                    bakeries: [{ name: "Pastelería-Cafetería La Gallega", address: "Calle San Roque" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Lourenzá", distance: 29 }] 
            },
            { 
                name: "Lourenzá", 
                albergues: [{ name: "Albergue de Peregrinos de Lourenzá", type: "Xunta", price: 10, address: "Calle do Convento 1", beds: 25, notes: "Struttura pubblica ben tenuta. Cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Supermercado Claudio", address: "Plaza del Conde Santo" }],
                    pharmacies: [{ name: "Farmacia de Lourenzá", address: "Calle del Convento" }],
                    bakeries: [],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Abadín", distance: 25 }] 
            },
            { 
                name: "Abadín", 
                albergues: [{ name: "Albergue de Peregrinos de Gontán", type: "Xunta", price: 10, address: "Gontán", beds: 26, notes: "Situato a Gontán, poco prima di Abadín. Cucina." }, { name: "Albergue Xabarín", type: "Privato", price: 14, address: "Avenida de Galicia 28", beds: 42, notes: "Buona alternativa privata." }], 
                amenities: { 
                    supermarkets: [{ name: "Supermercado en Gontán", address: "Carretera General" }],
                    pharmacies: [{ name: "Farmacia de Abadín", address: "Plaza del Ayuntamiento" }],
                    bakeries: [],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Vilalba", distance: 21 }] 
            },
            { 
                name: "Vilalba", 
                albergues: [{ name: "Albergue de Peregrinos de Vilalba", type: "Xunta", price: 10, address: "Rúa da Pravia 50", beds: 42, notes: "Grande e moderno. Cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Gadis", address: "Rúa da Pravia" }, { name: "Dia", address: "Avenida Terra Cha" }],
                    pharmacies: [{ name: "Farmacia Central", address: "Plaza de la Constitución" }],
                    bakeries: [{ name: "Pastelería-Panadería O Forno", address: "Rúa da Pravia" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Baamonde", distance: 20 }] 
            },
            { 
                name: "Baamonde", 
                albergues: [{ name: "Albergue de Peregrinos de Baamonde", type: "Xunta", price: 10, address: "Carretera de Vilalba 9", beds: 64, notes: "Grande e con un bel giardino. Cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Bar-Tienda", address: "Carretera General" }],
                    pharmacies: [],
                    bakeries: [],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Miraz", distance: 15 }, { name: "Sobrado dos Monxes", distance: 41 }] 
            },
            { 
                name: "Miraz", 
                albergues: [{ name: "Albergue de Peregrinos de Miraz", type: "Donativo", price: 5, address: "Corral da Fonte", beds: 26, notes: "Gestito dalla Confraternity of Saint James. Cucina." }], 
                amenities: { supermarkets: [], pharmacies: [], bakeries: [], trekking_stores: [] }, 
                nextTowns: [{ name: "Sobrado dos Monxes", distance: 26 }] 
            },
            { 
                name: "Sobrado dos Monxes", 
                albergues: [{ name: "Albergue del Monasterio de Sobrado", type: "Monastico", price: 10, address: "Monasterio de Santa María", beds: 120, notes: "Dormire in un monastero attivo. Cucina." }], 
                amenities: { 
                    supermarkets: [{ name: "Supermercado Claudio", address: "Avenida de Santiago" }],
                    pharmacies: [{ name: "Farmacia de Sobrado", address: "Plaza del Portal" }],
                    bakeries: [],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Arzúa", distance: 22 }] 
            },
            { 
                name: "Arzúa", 
                albergues: [{ name: "Albergue de Peregrinos de Arzúa", type: "Xunta", price: 10, address: "Rúa Cima do Lugar 6", beds: 56, notes: "Qui il Camino del Norte si unisce al Francés. Cucina." }, { name: "Albergue Vía Láctea", type: "Privato", price: 15, address: "Calle Xosé Neira Vilas 26", beds: 80, notes: "Una delle tante opzioni private." }], 
                amenities: { 
                    supermarkets: [{ name: "Gadis", address: "Rúa de Lugo" }, { name: "Dia", address: "Rúa de Lugo" }],
                    pharmacies: [{ name: "Farmacia de Arzúa", address: "Rúa de Lugo" }],
                    bakeries: [{ name: "Panadería-Pastelería Esmeralda", address: "Avenida de Lugo" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "O Pedrouzo", distance: 19 }] 
            },
            { 
                name: "O Pedrouzo", 
                albergues: [{ name: "Albergue de Peregrinos de Arca do Pino", type: "Xunta", price: 10, address: "Rúa do Concello 4", beds: 124, notes: "Ultima grande fermata pubblica. Cucina." }, { name: "Albergue Otero", type: "Privato", price: 15, address: "Rúa Forcarei 2", beds: 40, notes: "Opzione privata con giardino." }], 
                amenities: { 
                    supermarkets: [{ name: "Eroski", address: "Avenida de Santiago" }],
                    pharmacies: [{ name: "Farmacia de O Pino", address: "Avenida de Santiago" }],
                    bakeries: [{ name: "Panadería Pedrouzo", address: "Avenida de Santiago" }],
                    trekking_stores: []
                }, 
                nextTowns: [{ name: "Santiago de Compostela", distance: 20 }] 
            },
            { 
                name: "Santiago de Compostela", 
                albergues: [{ name: "Albergue Seminario Menor", type: "Privato", price: 15, address: "Avenida de Quiroga Palacios 2", beds: 250, notes: "Grande, con camere singole e multiple." }, { name: "Albergue Fin del Camino", type: "Privato", price: 15, address: "Rúa de Moscova 7", beds: 60, notes: "Popolare e ben recensito." }], 
                amenities: { 
                    supermarkets: [{ name: "Gadis", address: "Rúa do Hórreo" }, { name: "Mercadona", address: "Rúa de Frei Rosendo Salvado" }],
                    pharmacies: [{ name: "Farmacia Bescansa", address: "Praza do Toural" }],
                    bakeries: [{ name: "Pastelería Tarta de Santiago", address: "Rúa do Vilar" }],
                    trekking_stores: [{ name: "Decathlon City", address: "Centro Comercial As Cancelas" }, { name: "Cimalp", address: "Rúa da Senra" }]
                }, 
                nextTowns: [] 
            }
        ];


        // --- LOGICA DELL'APPLICAZIONE ---
        let currentTown = null;

        // Riferimenti agli elementi del DOM
        const townSelector = document.getElementById('townSelector');
        const searchBtn = document.getElementById('searchBtn');
        const errorOutput = document.getElementById('errorOutput');
        
        const resultsContainer = document.getElementById('results-container');
        const amenitiesOutput = document.getElementById('amenitiesOutput');
        const alberguesOutput = document.getElementById('alberguesOutput');
        const adviceOutput = document.getElementById('adviceOutput');

        // Riferimenti AI
        const getTownInfoBtn = document.getElementById('getTownInfoBtn');
        const planStageBtn = document.getElementById('planStageBtn');
        const aiLoading = document.getElementById('aiLoading');
        const aiOutput = document.getElementById('aiOutput');
        const aiError = document.getElementById('aiError');

        /**
         * Popola il menu a tendina con le città.
         */
        function populateTownSelector() {
            caminoData.forEach(town => {
                const option = document.createElement('option');
                option.value = town.name;
                option.textContent = town.name;
                townSelector.appendChild(option);
            });
        }

        /**
         * Pulisce i messaggi di errore.
         */
        function clearErrors() {
            errorOutput.textContent = '';
            aiError.textContent = '';
        }
        
        /**
         * Imposta la città corrente e aggiorna l'interfaccia.
         * @param {object} town L'oggetto città dal database.
         */
        function setCurrentTown(town) {
            currentTown = town;
            displayTownInfo(town);
            getTownInfoBtn.textContent = `Cosa vedere a ${town.name}? ✨`;
            planStageBtn.disabled = !town.nextTowns || town.nextTowns.length === 0;
            if (planStageBtn.disabled) {
                planStageBtn.title = "Sei arrivato alla fine del cammino!";
            } else {
                 planStageBtn.title = "";
            }
        }

        /**
         * Mostra tutte le informazioni per una data città.
         */
        function displayTownInfo(town) {
            displayAlbergues(town);
            displayAmenities(town);
            displayNextTowns(town);
            resultsContainer.classList.remove('hidden');
            aiOutput.classList.add('hidden'); // Nasconde l'output AI precedente
        }

        /**
         * Mostra i servizi per una data città.
         */
        function displayAmenities(town) {
            let html = '';
            const createList = (title, items) => {
                let listHtml = `<h3 class="font-semibold text-lg mt-4 mb-2 text-secondary">${title}</h3>`;
                if (items && items.length > 0) {
                    listHtml += `<ul class="space-y-1">`;
                    items.forEach(item => {
                        listHtml += `<li class="ml-4 list-disc">${item.name}${item.address ? ` - <span class="text-gray-600">${item.address}</span>` : ''}</li>`;
                    });
                    listHtml += `</ul>`;
                } else {
                    listHtml += `<p class="ml-4 italic">Nessun dato specifico disponibile.</p>`;
                }
                return listHtml;
            };

            html += createList('Supermercati', town.amenities.supermarkets);
            html += createList('Farmacie', town.amenities.pharmacies);
            html += createList('Panetterie / Pasticcerie', town.amenities.bakeries);
            html += createList('Negozi Trekking / Sport', town.amenities.trekking_stores);
            
            amenitiesOutput.innerHTML = html;
        }


        /**
         * Mostra gli albergue per una data città.
         */
        function displayAlbergues(town) {
            let html = '';
            if (town.albergues && town.albergues.length > 0) {
                town.albergues.sort((a, b) => (a.price || 999) - (b.price || 999));
                html += `<p class="mb-4">Elenco degli albergue a <strong>${town.name}</strong> (ordinati per prezzo):</p>`;
                town.albergues.forEach((alb, index) => {
                    const isCheapest = index === 0 && alb.price > 0;
                    const isDonativo = alb.type.toLowerCase().includes('donativo') || alb.type.toLowerCase().includes('parrocchiale') || alb.type.toLowerCase().includes('monastico');
                    const priceDisplay = isDonativo ? `Donativo (sugg. €${alb.price})` : `€${alb.price}`;

                    html += `
                        <div class="albergue-item ${isCheapest ? 'cheapest' : ''} ${isDonativo ? 'donativo' : ''}">
                            <p class="font-semibold">${alb.name} <span class="text-sm text-gray-600">(${alb.type})</span></p>
                            <p><strong>Prezzo:</strong> ${priceDisplay}</p>
                            <p><strong>Indirizzo:</strong> ${alb.address || 'N/A'}</p>
                            <p><strong>Posti letto:</strong> ${alb.beds > 0 ? alb.beds : 'N/A'}</p>
                            ${alb.notes ? `<p class="text-sm mt-1 text-gray-500"><em>Nota: ${alb.notes}</em></p>` : ''}
                        </div>
                    `;
                });
            } else {
                html += `<p>Nessun albergue principale (municipale/parrocchiale) registrato per <strong>${town.name}</strong>. Potrebbero esserci opzioni private non elencate.</p>`;
            }
            alberguesOutput.innerHTML = html;
        }

        /**
         * Mostra le informazioni sulle prossime tappe.
         */
        function displayNextTowns(town) {
            if (town.nextTowns && town.nextTowns.length > 0) {
                let adviceHtml = `<p class="mb-2">Da ${town.name}, puoi proseguire verso:</p><ul>`;
                town.nextTowns.forEach(nextTownInfo => {
                    adviceHtml += `<li class="ml-4 list-disc"><strong>${nextTownInfo.name}</strong> (circa ${nextTownInfo.distance} km)</li>`;
                });
                adviceHtml += `</ul>`;
                adviceOutput.innerHTML = adviceHtml;
            } else {
                adviceOutput.innerHTML = '<p class="font-bold text-secondary">Sei arrivato alla fine del percorso! ¡Buen Camino!</p>';
            }
        }

        /**
         * Funzione generica per chiamare l'API di Gemini.
         */
        async function callGemini(prompt) {
            aiLoading.classList.remove('hidden');
            aiOutput.classList.add('hidden');
            aiError.textContent = '';

            try {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = ""; // Lasciare vuoto
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Errore di rete: ${response.status}`);
                const result = await response.json();

                if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                    aiOutput.textContent = result.candidates[0].content.parts[0].text;
                    aiOutput.classList.remove('hidden');
                } else {
                    throw new Error("La risposta dell'AI non è nel formato atteso.");
                }
            } catch (error) {
                aiError.textContent = `Errore dell'assistente AI: ${error.message}`;
            } finally {
                aiLoading.classList.add('hidden');
            }
        }

        // --- EVENT LISTENERS ---

        searchBtn.addEventListener('click', () => {
            const selectedTownName = townSelector.value;
            clearErrors();
            
            const foundTown = caminoData.find(town => town.name === selectedTownName);
            if (foundTown) {
                setCurrentTown(foundTown);
            } else {
                errorOutput.textContent = "Seleziona una città valida.";
                resultsContainer.classList.add('hidden');
            }
        });

        getTownInfoBtn.addEventListener('click', () => {
            if (!currentTown) return;
            const prompt = `Sei una guida esperta del Camino de Santiago. Un pellegrino si trova a ${currentTown.name}. Fornisci una breve e accattivante descrizione in italiano che includa: 
1. Le principali attrazioni o punti di interesse.
2. Una specialità culinaria locale da non perdere.
3. Una curiosità o una leggenda interessante legata al posto.
Rispondi in modo conciso e in formato testuale.`;
            callGemini(prompt);
        });

        planStageBtn.addEventListener('click', () => {
            if (!currentTown || !currentTown.nextTowns || currentTown.nextTowns.length === 0) return;
            
            const nextStage = currentTown.nextTowns[0];
            const prompt = `Sei un saggio e pratico consigliere per pellegrini sul Camino de Santiago. Un pellegrino si trova a ${currentTown.name} e si prepara per la tappa di domani verso ${nextStage.name} (circa ${nextStage.distance} km). 
Crea un breve piano per la tappa in italiano, strutturato in questo modo:
1. **Il Percorso:** Descrivi brevemente il tipo di terreno che incontrerà (es. salite, discese, asfalto, sentieri).
2. **Da non Perdere:** Segnala un punto di interesse culturale o paesaggistico lungo il cammino.
3. **Consiglio Pratico:** Offri un suggerimento utile per questa specifica tappa (es. acqua, cibo, orari).
4. **Pensiero del Giorno:** Concludi con una breve frase motivazionale per il cammino.
Rispondi in modo chiaro e schematico.`;
            callGemini(prompt);
        });
        
        // Inizializzazione al caricamento della pagina
        window.onload = () => {
            populateTownSelector();
            // Opzionale: mostra la prima città di default
            const firstTown = caminoData.find(t => t.name === townSelector.value);
            if(firstTown) setCurrentTown(firstTown);
        };

    </script>
</body>
</html>
